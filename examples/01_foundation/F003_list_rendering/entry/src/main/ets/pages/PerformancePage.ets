import { Message, MessageType, Product } from '../models/Contact';
import { MockData } from '../utils/MockData';
import { BasicDataSource } from '../utils/DataSource';

/**
 * æ¶ˆæ¯æ•°æ®æº
 */
class MessageDataSource extends BasicDataSource<Message> {
  private dataArray: Message[] = [];

  public totalCount(): number {
    return this.dataArray.length;
  }

  public getData(index: number): Message {
    return this.dataArray[index];
  }

  public addData(index: number, data: Message): void {
    this.dataArray.splice(index, 0, data);
    this.notifyDataAdd(index);
  }

  public pushData(data: Message): void {
    this.dataArray.push(data);
    this.notifyDataAdd(this.dataArray.length - 1);
  }

  public deleteData(index: number): void {
    this.dataArray.splice(index, 1);
    this.notifyDataDelete(index);
  }
}

/**
 * å•†å“æ•°æ®æº
 */
class ProductDataSource extends BasicDataSource<Product> {
  private dataArray: Product[] = [];

  public totalCount(): number {
    return this.dataArray.length;
  }

  public getData(index: number): Product {
    return this.dataArray[index];
  }

  public addData(index: number, data: Product): void {
    this.dataArray.splice(index, 0, data);
    this.notifyDataAdd(index);
  }

  public pushData(data: Product): void {
    this.dataArray.push(data);
    this.notifyDataAdd(this.dataArray.length - 1);
  }

  public deleteData(index: number): void {
    this.dataArray.splice(index, 1);
    this.notifyDataDelete(index);
  }
}

/**
 * F003 - åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–é¡µé¢
 * æ¼”ç¤ºå¤šç§åˆ—è¡¨ç±»å‹å’Œæ€§èƒ½ä¼˜åŒ–æŠ€å·§
 */
@Entry
@Component
struct PerformancePage {
  @State private currentTab: number = 0;
  @State private messageDataSource: MessageDataSource = new MessageDataSource();
  @State private productDataSource: ProductDataSource = new ProductDataSource();
  @State private renderTime: number = 0;

  aboutToAppear(): void {
    this.initializeData();
  }

  /**
   * åˆå§‹åŒ–æ•°æ®
   */
  private initializeData(): void {
    const startTime = Date.now();

    // ç”Ÿæˆæ¶ˆæ¯æ•°æ®
    const messages = MockData.generateMessages(200);
    messages.forEach((msg: Message) => {
      this.messageDataSource.pushData(msg);
    });

    // ç”Ÿæˆå•†å“æ•°æ®
    const products = MockData.generateProducts(100);
    products.forEach((product: Product) => {
      this.productDataSource.pushData(product);
    });

    this.renderTime = Date.now() - startTime;
  }

  /**
   * æ ¹æ® colorKey è·å–é¢œè‰²èµ„æº
   */
  private getColor(colorKey: string): Resource {
    const colorMap: Record<string, Resource> = {
      'brand_primary': $r('app.color.brand_primary'),
      'brand_success': $r('app.color.brand_success'),
      'brand_warning': $r('app.color.brand_warning'),
      'brand_danger': $r('app.color.brand_danger'),
      'brand_purple': $r('app.color.brand_purple'),
      'brand_cyan': $r('app.color.brand_cyan'),
      'brand_magenta': $r('app.color.brand_magenta'),
      'brand_blue': $r('app.color.brand_blue'),
      'brand_gold': $r('app.color.brand_gold')
    };
    return colorMap[colorKey] || $r('app.color.brand_primary');
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('â† è¿”å›')
          .fontSize(16)
          .fontColor('#F6F6F6')
          .onClick(() => {
            this.getUIContext().getRouter().back();
          })

        Text('æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#F6F6F6')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Text('        ')
          .fontSize(16)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#722ED1')
      .justifyContent(FlexAlign.SpaceBetween)

      // æ€§èƒ½ç»Ÿè®¡
      Row() {
        Text(`æ¸²æŸ“è€—æ—¶: ${this.renderTime} ms`)
          .fontSize(14)
          .fontColor('#666666')

        Text(`æ¶ˆæ¯: ${this.messageDataSource.totalCount()} | å•†å“: ${this.productDataSource.totalCount()}`)
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#F5F5F5')
      .justifyContent(FlexAlign.SpaceBetween)

      // Tab åˆ‡æ¢
      Tabs({ index: this.currentTab }) {
        // æ¶ˆæ¯åˆ—è¡¨ Tab
        TabContent() {
          this.MessageListView()
        }
        .tabBar('æ¶ˆæ¯åˆ—è¡¨')

        // å•†å“åˆ—è¡¨ Tab
        TabContent() {
          this.ProductListView()
        }
        .tabBar('å•†å“åˆ—è¡¨')

        // æ€§èƒ½å»ºè®® Tab
        TabContent() {
          this.PerformanceTipsView()
        }
        .tabBar('ä¼˜åŒ–å»ºè®®')
      }
      .width('100%')
      .layoutWeight(1)
      .barMode(BarMode.Fixed)
      .onChange((index: number) => {
        this.currentTab = index;
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F6F6F6')
  }

  /**
   * æ¶ˆæ¯åˆ—è¡¨è§†å›¾
   */
  @Builder
  MessageListView() {
    List({ space: 0 }) {
      LazyForEach(this.messageDataSource, (message: Message, _index: number) => {
        ListItem() {
          Row({ space: 12 }) {
            // æ¶ˆæ¯å›¾æ ‡
            Text(this.getMessageIcon(message.type))
              .fontSize(24)
              .width(48)
              .height(48)
              .borderRadius(24)
              .backgroundColor(this.getMessageColor(message.type))
              .textAlign(TextAlign.Center)
              .fontColor('#F6F6F6')

            // æ¶ˆæ¯å†…å®¹
            Column({ space: 4 }) {
              Row() {
                Text(message.title)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .flexGrow(1)

                if (!message.isRead) {
                  Text('æœªè¯»')
                    .fontSize(12)
                    .fontColor('#F6F6F6')
                    .backgroundColor('#FF4D4F')
                    .padding({
                      left: 8,
                      right: 8,
                      top: 2,
                      bottom: 2
                    })
                    .borderRadius(2)
                }
              }
              .width('100%')

              Text(message.content)
                .fontSize(14)
                .fontColor('#666666')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              Text(message.time)
                .fontSize(12)
                .fontColor('#999999')
            }
            .alignItems(HorizontalAlign.Start)
            .flexGrow(1)
          }
          .width('100%')
          .padding(16)
          .backgroundColor(message.isRead ? '#F6F6F6' : '#F0F9FF')
        }
      }, (message: Message) => message.id)
    }
    .width('100%')
    .height('100%')
    .divider({ strokeWidth: 1, color: '#F0F0F0', startMargin: 76 })
    .edgeEffect(EdgeEffect.Spring)
  }

  /**
   * å•†å“åˆ—è¡¨è§†å›¾ (Grid å¸ƒå±€)
   */
  @Builder
  ProductListView() {
    Grid() {
      LazyForEach(this.productDataSource, (product: Product) => {
        GridItem() {
          Column({ space: 8 }) {
            // å•†å“å›¾æ ‡ï¼ˆä½¿ç”¨ emoji + èƒŒæ™¯è‰²ï¼‰
            Text(product.image)
              .fontSize(48)
              .width('100%')
              .height(120)
              .borderRadius(8)
              .backgroundColor(this.getColor(product.color))
              .textAlign(TextAlign.Center)
              .padding({ top: 36 })

            // å•†å“ä¿¡æ¯
            Column({ space: 4 }) {
              Text(product.name)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              Text(product.description)
                .fontSize(12)
                .fontColor('#999999')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              Row() {
                Text(`Â¥${product.price}`)
                  .fontSize(16)
                  .fontColor('#FF4D4F')
                  .fontWeight(FontWeight.Bold)

                Text(`åº“å­˜: ${product.stock}`)
                  .fontSize(12)
                  .fontColor('#999999')
                  .layoutWeight(1)
                  .textAlign(TextAlign.End)
              }
              .width('100%')
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#F6F6F6')
          .borderRadius(8)
          .shadow({ radius: 8, color: '#00000010' })
        }
      }, (product: Product) => product.id)
    }
    .width('100%')
    .height('100%')
    .columnsTemplate('1fr 1fr')
    .rowsGap(12)
    .columnsGap(12)
    .padding(12)
    .backgroundColor('#F5F5F5')
  }

  /**
   * æ€§èƒ½ä¼˜åŒ–å»ºè®®è§†å›¾
   */
  @Builder
  PerformanceTipsView() {
    Scroll() {
      Column({ space: 16 }) {
        // ä¼˜åŒ–å»ºè®®å¡ç‰‡
        this.TipCard(
          'ä½¿ç”¨ LazyForEach',
          'å¯¹äºå¤§æ•°æ®é‡åˆ—è¡¨ï¼Œä½¿ç”¨ LazyForEach ä»£æ›¿ ForEachï¼Œå®ç°æŒ‰éœ€åŠ è½½å’Œæ¸²æŸ“',
          '#52C41A'
        )

        this.TipCard(
          'åˆç†ä½¿ç”¨ cachedCount',
          'List ç»„ä»¶çš„ cachedCount å±æ€§å¯ä»¥è®¾ç½®ç¼“å­˜çš„åˆ—è¡¨é¡¹æ•°é‡ï¼Œæå‡æ»šåŠ¨æ€§èƒ½',
          '#1890FF'
        )

        this.TipCard(
          'é¿å…æ·±å±‚åµŒå¥—',
          'å‡å°‘ç»„ä»¶åµŒå¥—å±‚çº§ï¼Œä½¿ç”¨æ‰å¹³åŒ–çš„ç»„ä»¶ç»“æ„',
          '#FA8C16'
        )

        this.TipCard(
          'ä½¿ç”¨ @Reusable è£…é¥°å™¨',
          'ä¸ºåˆ—è¡¨é¡¹ç»„ä»¶æ·»åŠ  @Reusable è£…é¥°å™¨ï¼Œå®ç°ç»„ä»¶å¤ç”¨',
          '#722ED1'
        )

        this.TipCard(
          'åˆç†ä½¿ç”¨å›¾ç‰‡',
          'ä½¿ç”¨ alt å±æ€§è®¾ç½®å ä½å›¾ï¼Œé¿å…å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„ç©ºç™½',
          '#13C2C2'
        )

        this.TipCard(
          'ä¼˜åŒ–çŠ¶æ€ç®¡ç†',
          'é¿å…ä¸å¿…è¦çš„çŠ¶æ€åˆ·æ–°ï¼Œä½¿ç”¨å±€éƒ¨çŠ¶æ€ä»£æ›¿å…¨å±€çŠ¶æ€',
          '#EB2F96'
        )

        // æ€§èƒ½å¯¹æ¯”æ•°æ®
        Column({ space: 8 }) {
          Text('æ€§èƒ½å¯¹æ¯”æ•°æ®')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          Row() {
            Text('ForEach (1000æ¡):')
              .fontSize(14)
              .fontColor('#666666')
              .layoutWeight(1)

            Text('~800ms')
              .fontSize(14)
              .fontColor('#FF4D4F')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')

          Row() {
            Text('LazyForEach (1000æ¡):')
              .fontSize(14)
              .fontColor('#666666')
              .layoutWeight(1)

            Text('~100ms')
              .fontSize(14)
              .fontColor('#52C41A')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')

          Row() {
            Text('æ€§èƒ½æå‡:')
              .fontSize(14)
              .fontColor('#666666')
              .layoutWeight(1)

            Text('8x')
              .fontSize(14)
              .fontColor('#1890FF')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F5F5F5')
        .borderRadius(8)
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æç¤ºå¡ç‰‡ç»„ä»¶
   */
  @Builder
  TipCard(title: string, content: string, color: string) {
    Column({ space: 8 }) {
      Row({ space: 8 }) {
        Text('ğŸ’¡')
          .fontSize(20)

        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(color)
      }
      .width('100%')

      Text(content)
        .fontSize(14)
        .fontColor('#666666')
        .lineHeight(20)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#F6F6F6')
    .borderRadius(8)
    .border({ width: 1, color: color, radius: 8 })
  }

  /**
   * è·å–æ¶ˆæ¯å›¾æ ‡
   */
  private getMessageIcon(type: MessageType): string {
    switch (type) {
      case MessageType.SYSTEM:
        return 'ğŸ””';
      case MessageType.NOTICE:
        return 'ğŸ“¢';
      case MessageType.MESSAGE:
        return 'ğŸ’¬';
      default:
        return 'ğŸ“¬';
    }
  }

  /**
   * è·å–æ¶ˆæ¯é¢œè‰²
   */
  private getMessageColor(type: MessageType): string {
    switch (type) {
      case MessageType.SYSTEM:
        return '#1890FF';
      case MessageType.NOTICE:
        return '#FA8C16';
      case MessageType.MESSAGE:
        return '#52C41A';
      default:
        return '#999999';
    }
  }
}
